# Authentication Implementation Guide

JavaScript only, Tailwind styling. before touching auth code. This guide explains how the auth stack fits together so you can extend it confidently.

## Quick Orientation
- **Stack**: Next.js 15 (React 19) on the frontend, Convex for backend/data, `@convex-dev/auth` for auth state, Cloudflare Turnstile for bot protection, Resend for OTP email delivery.
- **Philosophy**: keep auth logic thin on the client, trust Convex actions/queries, gate routes early via middleware, and reuse the shared `signIn`/`signOut` helpers supplied by Convex Auth.
- **Key flows**: password sign-in & sign-up share one form, password reset uses a two-step OTP flow, middleware enforces access to `/dashboard`, `/account`, and `/admin` routes.

## File Map (auth-related)
```
app/
├── layout.js                 # Registers Convex auth provider server-side
├── providers.js              # Client-side Convex provider (auth context)
├── (auth)/signin/page.js     # Combined sign-in/sign-up experience
├── (auth)/reset-password/    # Two-step password reset UI
│   └── page.js
├── components/Navbar.js      # Auth-aware navigation (sign out button, etc.)

convex/
├── auth.js                   # Convex Auth configuration + OTP mailer + helpers
├── auth.config.js            # Domain/application binding for Convex Auth
├── http.js                   # Registers auth HTTP routes for Next.js
├── turnstile.js              # Action for server-side Turnstile verification
├── users.js                  # Queries exposing current user data to the UI
├── schema.js                 # Auth tables + profile metadata

middleware.js                 # Next.js middleware enforcing route protection
```
Autogenerated files under `convex/_generated` wire Convex actions/queries into the client. Do not edit them manually.

## How the Pieces Fit Together
1. **Providers**: `app/layout.js` wraps every request with `ConvexAuthNextjsServerProvider`. `app/providers.js` instantiates the browser client (`ConvexReactClient`) and exposes it through `ConvexAuthNextjsProvider`.
2. **User action → Turnstile**: Auth forms embed Cloudflare Turnstile. The client calls `api.turnstile.verify` before attempting any auth flow.
3. **Auth command**: The same `signIn("password", formData)` helper triggers sign-in, sign-up, or password reset depending on the hidden `flow` field. Convex Auth handles the specifics and issues/refreshes session tokens automatically.
4. **Session → UI**: React components use `Authenticated`, `Unauthenticated`, `AuthLoading`, and Convex queries (e.g. `api.users.getMe`) to render the correct state. `useAuthActions().signOut()` clears the session.
5. **Routing**: `middleware.js` performs early redirects for auth pages, protected user areas, and admin routes before the request reaches a page.

## Frontend Implementation Details

### Root Providers (`app/layout.js`, `app/providers.js`)
`app/layout.js` keeps the auth provider in the Server Components tree so every request can read auth state:
```javascript
import { ConvexAuthNextjsServerProvider } from "@convex-dev/auth/nextjs/server";
import Providers from "@/app/providers";

export default function RootLayout({ children }) {
  return (
    <ConvexAuthNextjsServerProvider>
      <html lang="en">
        <body>
          <Script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer />
          <Providers>
            <Navbar />
            {children}
          </Providers>
        </body>
      </html>
    </ConvexAuthNextjsServerProvider>
  );
}
```
`app/providers.js` is the client-side bridge. It reuses one `ConvexReactClient` instance and exposes auth hooks/UI helpers everywhere in the app.

### Sign-In & Sign-Up (`app/(auth)/signin/page.js`)
- One page handles both flows; state toggles the `flow` hidden input between `signIn` and `signUp`.
- On submit we:
  1. Gather form data and Turnstile token.
  2. Call `verifyTurnstile({ token })`.
  3. Call `signIn("password", formData)`.
- Navigation changes are handled by middleware and the auth provider; the page itself just surfaces inline errors.
- Minimum password length is enforced via HTML `minLength={8}` and server-side in Convex Auth.

Key excerpt:
```javascript
const { signIn } = useAuthActions();
const verifyTurnstile = useAction(api.turnstile.verify);

await verifyTurnstile({ token: String(fd.get("cf-turnstile-response") || "") });
await signIn("password", fd);
```

### Password Reset (`app/(auth)/reset-password/page.js`)
- **Step 1** (`flow="reset"`): verify Turnstile, trigger `signIn("password", formData)` to request an OTP, show feedback, store the email locally.
- **Step 2** (`flow="reset-verification"`): send OTP plus new password via `signIn("password", formData)`. On success redirect back to `/signin`.
- Turnstile protects the reset request to block automated abuse.

### Auth-Aware Navigation (`components/Navbar.js`)
The navbar demonstrates how to consume auth state and sign out:
```javascript
import { Authenticated, AuthLoading, Unauthenticated } from "convex/react";
import { useAuthActions } from "@convex-dev/auth/react";
import { api } from "@/convex/_generated/api";

export function Navbar() {
  const { signOut } = useAuthActions();
  const me = useQuery(api.users.getMe) ?? null;

  return (
    <nav>
      <AuthLoading>Loading...</AuthLoading>
      <Authenticated>
        <span>{me?.email}</span>
        <button onClick={() => void signOut()}>Sign out</button>
      </Authenticated>
      <Unauthenticated>
        <a href="/signin">Sign in</a>
      </Unauthenticated>
    </nav>
  );
}
```
Use this pattern for any other auth-aware component.

## Backend Implementation Details

### Convex Auth configuration (`convex/auth.js`)
```javascript
import { convexAuth } from "@convex-dev/auth/server";
import { Password } from "@convex-dev/auth/providers/Password";
import Resend from "@auth/core/providers/resend";
import { Resend as ResendAPI } from "resend";
import { generateRandomString } from "@oslojs/crypto/random";

export const ResendOTPPasswordReset = Resend({
  id: "resend-otp",
  apiKey: process.env.AUTH_RESEND_KEY,
  async generateVerificationToken() {
    const random = { read: (bytes) => crypto.getRandomValues(bytes) };
    return generateRandomString(random, "0123456789", 8);
  },
  async sendVerificationRequest({ identifier: email, provider, token }) {
    const resend = new ResendAPI(provider.apiKey);
    const { error } = await resend.emails.send({
      from: "NoviaChat <no-reply@noviachat.com>",
      to: [email],
      subject: "Reset your password",
      text: `Your password reset code is ${token}`,
    });
    if (error) throw new Error("Could not send reset code email");
  },
});

export const { auth, signIn, signOut, store, isAuthenticated } = convexAuth({
  providers: [
    Password({
      reset: ResendOTPPasswordReset,
      profile(params) {
        const email = (params.email ?? "").trim().toLowerCase();
        return { email };
      },
    }),
  ],
});
```
- The password provider powers sign-in, sign-up, and reset flows.
- `profile` runs for every flow; keep it synchronous and only return fields that belong on the `users` document.
- `signIn` and `signOut` are imported directly by client components through Convex’s generated API bindings.

### Turnstile verification (`convex/turnstile.js`)
A dedicated action verifies Cloudflare tokens server-side before any auth work happens:
```javascript
import { action } from "./_generated/server";
import { v } from "convex/values";

export const verify = action({
  args: { token: v.string() },
  handler: async (_ctx, { token }) => {
    if (!token) throw new Error("Turnstile token missing");
    const res = await fetch("https://challenges.cloudflare.com/turnstile/v0/siteverify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        secret: process.env.TURNSTILE_SECRET_KEY,
        response: token,
      }),
    });
    if (!res.ok) throw new Error("Turnstile verification failed");
    const data = await res.json();
    if (!data.success) throw new Error("Turnstile verification failed");
    return { ok: true };
  },
});
```
This action is exposed to the frontend as `api.turnstile.verify`.

### HTTP routes & config
- `convex/http.js` registers Convex Auth’s HTTP endpoints so Next.js can call them during SSR and middleware execution.
- `convex/auth.config.js` binds the deployment domain; update `CONVEX_SITE_URL` when environments change.

### Database schema (`convex/schema.js`)
Auth-specific pieces live alongside other tables:
```javascript
import { authTables } from "@convex-dev/auth/server";

const schema = defineSchema({
  ...authTables, // brings in Convex Auth tables including "users"
  profiles: defineTable({
    userId: v.id("users"),
    role: v.optional(v.literal("admin")),
    username: v.optional(v.string()),
    usernameLower: v.optional(v.string()),
    name: v.optional(v.string()),
    age: v.optional(v.number()),
    country: v.optional(v.string()),
    avatarKey: v.optional(v.string()),
    updatedAt: v.number(),
  })
    .index("by_userId", ["userId"])
    .index("by_usernameLower", ["usernameLower"]),
  // Other domain tables omitted for brevity
});
```
Use the stable `users` table (from `authTables`) for email plus auth metadata; keep profile-specific data in `profiles`.

### User queries (`convex/users.js`)
Both `me` and `getMe` demonstrate how to access the auth user:
```javascript
import { query } from "./_generated/server";
import { getAuthUserId } from "@convex-dev/auth/server";

export const getMe = query({
  args: {},
  handler: async (ctx) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) return null;

    const userDoc = await ctx.db.get(userId);
    const profile = await ctx.db
      .query("profiles")
      .withIndex("by_userId", (q) => q.eq("userId", userId))
      .first();

    return {
      email: userDoc?.email ?? "",
      role: profile?.role ?? null,
    };
  },
});
```
`getAuthUserId` returns a stable identifier that never changes between sessions; prefer it over subject claims.

## Security Controls & Best Practices
- **Cloudflare Turnstile**: mandatory on every auth mutation (sign-in, sign-up, reset). Frontend widgets emit the token; backend verification runs before continuing.
- **Password policy**: minimum eight characters enforced on both client and server. Strength requirements can be extended by uncommenting or implementing `validatePasswordRequirements` in `convex/auth.js`.
- **Email OTP**: Resend sends an 8-digit numeric token. Convex Auth manages expiry and throttling automatically.
- **Sessions**: `ConvexAuthNextjsProvider` handles session token storage and refresh. Components should rely on the provided hooks and wrappers instead of touching cookies or localStorage directly.
- **Route protection** (`middleware.js`):
  - Redirects authenticated users away from `/signin` and `/reset-password`.
  - Requires authentication for `/dashboard(.*)` and `/account(.*)`.
  - Locks `/admin(.*)` behind authentication (role checks happen in Convex handlers).
  - Match config excludes static assets: `matcher: ["/((?!.*\\..*|_next).*)", "/", "/(api|trpc)(.*)"]`.

## Environment Variables
```
# Convex deployment
NEXT_PUBLIC_CONVEX_URL=...     # used by the browser client
CONVEX_SITE_URL=...            # fully qualified URL for SSR/middleware

# Cloudflare Turnstile
NEXT_PUBLIC_TURNSTILE_SITE_KEY=...
TURNSTILE_SECRET_KEY=...

# Resend (OTP email)
AUTH_RESEND_KEY=...
```
Keep secrets out of the repo. Both Convex and Next.js builds require these values.

## Dependencies of Note (`package.json`)
```
"@convex-dev/auth": "^0.0.90"
"@auth/core": "^0.37.4"
"@oslojs/crypto": "^1.0.1"
"convex": "^1.27.3"
"resend": "^6.1.0"
```
Next.js and React are already configured at 15.x and 19.x respectively; see `package.json` for the full list.

## Extending the Auth System (Agent Playbook)
- **New protected pages**: add the route pattern to `isProtected` or `isAdminArea` in `middleware.js`. For role-specific access, enforce checks in the relevant Convex query or action (use `api.users.getMe` as the shape reference).
- **Require auth in Convex functions**: call `getAuthUserId(ctx)` at the top of the query or action. Return early if it is missing. Use the stable ID to look up profile data.
- **Capture profile metadata**: extend the `profiles` table (and accompanying write mutations) rather than storing additional fields on `users`. Cross-reference `account_auth_implementation.md` for profile workflows.
- **Add a new auth UI flow**: reuse the Turnstile plus `signIn("password", formData)` pattern. Convex Auth determines the action from the `flow` field—stick to documented flows (`signIn`, `signUp`, `reset`, `reset-verification`) or consult Convex Auth docs before inventing new ones.
- **Customize emails**: modify the template inside `ResendOTPPasswordReset.sendVerificationRequest`. Keep the from-address in sync with verified domain records to avoid spam filters.
- **Support another provider**: add another provider object inside the `providers` array in `convex/auth.js`. Update Turnstile handling if the new flow collects user input before auth.
- **Keep UX consistent**: follow the Tailwind conventions already in the auth pages. No TypeScript; auth forms stay as client components by design.

## Troubleshooting & Verification
- **Turnstile errors**: confirm site and secret keys in `.env` and check Cloudflare’s dashboard for widget status.
- **OTP delivery issues**: verify `AUTH_RESEND_KEY` and sender domain configuration. Resend returns an `error` object; we surface failures via thrown errors.
- **Local testing**: run `next dev` with Cloudflare test keys (`1x00000000000000000000AA`, etc.). Ensure the Convex dev deployment uses the same `CONVEX_SITE_URL` value that Next.js is configured with.
- **Session confusion**: if UI state feels stuck, confirm components call `useAuthActions()` rather than mutating storage manually. Clearing browser storage should not normally be required.

## Related Documentation
- [AGENTS.md](AGENTS.md): global contributor rules and quick links.
- [account_auth_implementation.md](account_auth_implementation.md): user profile fields, account flows, and how auth ties into account management.
- [s3-cloudfront-implementation.md](s3-cloudfront-implementation.md): storage layer used by avatars and backgrounds referenced in auth-related UIs.
